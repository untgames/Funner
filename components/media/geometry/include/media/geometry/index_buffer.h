#ifndef MEDIALIB_GEOMETRY_INDEX_BUFFER_HEADER
#define MEDIALIB_GEOMETRY_INDEX_BUFFER_HEADER

#include <media/geometry/defs.h>

#include <xtl/functional_fwd>
#include <xtl/intrusive_ptr.h>

namespace media
{

namespace geometry
{

///////////////////////////////////////////////////////////////////////////////////////////////////
///Тип индксов
///////////////////////////////////////////////////////////////////////////////////////////////////
enum IndexType
{
  IndexType_UInt32,
  IndexType_UInt16,
  IndexType_UInt8,  
  
  IndexType_Num,
  
  IndexType_Default = IndexType_UInt32
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Утилиты
///////////////////////////////////////////////////////////////////////////////////////////////////
const char*   get_index_type_name (IndexType); //имя типа
unsigned char get_index_type_size (IndexType); //размер индекса

///////////////////////////////////////////////////////////////////////////////////////////////////
///Индексный буфер
///////////////////////////////////////////////////////////////////////////////////////////////////
class IndexBuffer
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    IndexBuffer  ();
    IndexBuffer  (uint32_t indices_count, IndexType type = IndexType_Default);
    IndexBuffer  (const IndexBuffer&);
    IndexBuffer  (const IndexBuffer&, IndexType type);
    ~IndexBuffer ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    IndexBuffer& operator = (const IndexBuffer&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание копии
///////////////////////////////////////////////////////////////////////////////////////////////////
    IndexBuffer Clone () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Идентификатор буфера (уникальный)
///////////////////////////////////////////////////////////////////////////////////////////////////
    object_id_t Id () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Идентификатор буфера из которого был клонирован / десериализован данный буфер
///////////////////////////////////////////////////////////////////////////////////////////////////
    object_id_t SourceId () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Тип индексов
///////////////////////////////////////////////////////////////////////////////////////////////////
    IndexType DataType    () const;
    void      SetDataType (IndexType type);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Данные
///////////////////////////////////////////////////////////////////////////////////////////////////
    const void* Data () const;
          void* Data ();
          
    template <class T> const T* Data () const;
    template <class T>       T* Data ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Количество индексов
///////////////////////////////////////////////////////////////////////////////////////////////////
    uint32_t Size   () const;
    void     Resize (uint32_t indices_count);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Очистка буфера
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Clear ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Резервирование памяти
///////////////////////////////////////////////////////////////////////////////////////////////////
    uint32_t Capacity () const;
    void     Reserve  (uint32_t indices_count);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Увеличение индекса обновления / Текущий индекс обновления
///////////////////////////////////////////////////////////////////////////////////////////////////
    void InvalidateData ();

    unsigned int CurrentStructureUpdateIndex () const;
    unsigned int CurrentDataUpdateIndex      () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Сериализация / десериализация
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t SerializationSize     () const;
    size_t SerializationDataSize () const;

    size_t Write     (void* buffer, size_t buffer_size) const;
    size_t WriteData (void* buffer, size_t buffer_size) const;
    size_t Read      (const void* buffer, size_t buffer_size);
    size_t ReadData  (const void* buffer, size_t buffer_size);

    static IndexBuffer CreateFromSerializedData (const void* buffer, size_t buffer_size, size_t& bytes_read);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Объект оповещения об удалении
///////////////////////////////////////////////////////////////////////////////////////////////////
    xtl::trackable& Trackable () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (IndexBuffer&);

  private:
    struct Impl;

    IndexBuffer (Impl*);

  private:
    xtl::intrusive_ptr<Impl> impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение объекта оповещения об удалении
///////////////////////////////////////////////////////////////////////////////////////////////////
xtl::trackable& get_trackable (const IndexBuffer&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
void swap (IndexBuffer&, IndexBuffer&);

#include <media/geometry/detail/index_buffer.inl>

}

}

#endif
