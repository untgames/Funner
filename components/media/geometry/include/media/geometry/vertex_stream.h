#ifndef MEDIALIB_GEOMETRY_VERTEX_STREAM_HEADER
#define MEDIALIB_GEOMETRY_VERTEX_STREAM_HEADER

#include <stdint.h>

#include <media/geometry/defs.h>
#include <media/geometry/vertex_format.h>
#include <xtl/intrusive_ptr.h>

namespace media
{

namespace geometry
{

//forward declarations
class VertexBuffer;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Объявление вершины
///////////////////////////////////////////////////////////////////////////////////////////////////
class VertexDeclaration
{
  public:
    VertexDeclaration (const VertexFormat&);
    VertexDeclaration (const VertexFormat&, uint32_t vertex_size);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение параметров
///////////////////////////////////////////////////////////////////////////////////////////////////
    const VertexFormat& Format     () const;
    uint32_t            VertexSize () const;

  private:
    const VertexFormat* format;
    uint32_t            vertex_size;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание объявления вершины
///////////////////////////////////////////////////////////////////////////////////////////////////
template <class Vertex> VertexDeclaration make_vertex_declaration ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Массив вершинных атрибутов
///////////////////////////////////////////////////////////////////////////////////////////////////
class VertexStream
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    VertexStream  (const VertexDeclaration& declaration);
    VertexStream  (uint32_t vertices_count, const VertexDeclaration& declaration);
    VertexStream  (const VertexBuffer& source);
    VertexStream  (const VertexStream& source, const VertexDeclaration& declaration);
    VertexStream  (const VertexBuffer& source, const VertexDeclaration& declaration);
    VertexStream  (const VertexStream&);
    ~VertexStream ();
    
    template <class Vertex> VertexStream (uint32_t);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    VertexStream& operator = (const VertexStream&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание копии
///////////////////////////////////////////////////////////////////////////////////////////////////
    VertexStream Clone () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Идентификатор потока (уникальный)
///////////////////////////////////////////////////////////////////////////////////////////////////
    object_id_t Id () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Идентификатор потока из которого был клонирован / десериализован данный поток
///////////////////////////////////////////////////////////////////////////////////////////////////
    object_id_t SourceId () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Формат
///////////////////////////////////////////////////////////////////////////////////////////////////
    const VertexFormat& Format () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Размер вершины
///////////////////////////////////////////////////////////////////////////////////////////////////
    uint32_t VertexSize () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение данных
///////////////////////////////////////////////////////////////////////////////////////////////////
    const void* Data () const;
          void* Data ();
          
    template <class Vertex> const Vertex* Data () const;
    template <class Vertex>       Vertex* Data ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Количество вершин
///////////////////////////////////////////////////////////////////////////////////////////////////
    uint32_t Size   () const;
    void     Resize (uint32_t vertices_count);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Очистка массива
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Clear ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Резервирование памяти
///////////////////////////////////////////////////////////////////////////////////////////////////
    uint32_t Capacity () const;
    void     Reserve  (uint32_t vertices_count);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Увеличение индекса обновления / Текущий индекс обновления
///////////////////////////////////////////////////////////////////////////////////////////////////
    void InvalidateData ();

    unsigned int CurrentStructureUpdateIndex () const;
    unsigned int CurrentDataUpdateIndex      () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Сериализация / десериализация
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t SerializationSize     () const;
    size_t SerializationDataSize () const;

    size_t Write     (void* buffer, size_t buffer_size) const;
    size_t WriteData (void* buffer, size_t buffer_size) const;
    size_t Read      (const void* buffer, size_t buffer_size);
    size_t ReadData  (const void* buffer, size_t buffer_size);

    static VertexStream CreateFromSerializedData (const void* buffer, size_t buffer_size, size_t& bytes_read);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Объект оповещения об удалении
///////////////////////////////////////////////////////////////////////////////////////////////////
    xtl::trackable& Trackable () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (VertexStream&);

  private:
    void Convert (const VertexStream&);
    void Convert (const VertexBuffer&);

  private:
    struct Impl;
    
    VertexStream (Impl*);
    
  private:
    xtl::intrusive_ptr<Impl> impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение объекта оповещения об удалении
///////////////////////////////////////////////////////////////////////////////////////////////////
xtl::trackable& get_trackable (const VertexStream&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
void swap (VertexStream&, VertexStream&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Массив вершинных весов
///////////////////////////////////////////////////////////////////////////////////////////////////
class VertexWeightStream
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    VertexWeightStream  ();
    VertexWeightStream  (uint32_t weights_count);
    VertexWeightStream  (const VertexWeightStream&);
    ~VertexWeightStream ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    VertexWeightStream& operator = (const VertexWeightStream&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание копии
///////////////////////////////////////////////////////////////////////////////////////////////////
    VertexWeightStream Clone () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Идентификатор потока (уникальный)
///////////////////////////////////////////////////////////////////////////////////////////////////
    object_id_t Id () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Идентификатор потока из которого был клонирован / десериализован данный поток
///////////////////////////////////////////////////////////////////////////////////////////////////
    object_id_t SourceId () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение данных
///////////////////////////////////////////////////////////////////////////////////////////////////
    const VertexWeight* Data () const;
          VertexWeight* Data ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Количество вершин
///////////////////////////////////////////////////////////////////////////////////////////////////
    uint32_t Size   () const;
    void     Resize (uint32_t weights_count);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Очистка массива
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Clear ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Резервирование памяти
///////////////////////////////////////////////////////////////////////////////////////////////////
    uint32_t Capacity () const;
    void     Reserve  (uint32_t weights_count);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Увеличение индекса обновления / Текущий индекс обновления
///////////////////////////////////////////////////////////////////////////////////////////////////
    void InvalidateData ();

    unsigned int CurrentStructureUpdateIndex () const;
    unsigned int CurrentDataUpdateIndex      () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Сериализация / десериализация
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t SerializationSize     () const;
    size_t SerializationDataSize () const;

    size_t Write     (void* buffer, size_t buffer_size) const;
    size_t WriteData (void* buffer, size_t buffer_size) const;
    size_t Read      (const void* buffer, size_t buffer_size);
    size_t ReadData  (const void* buffer, size_t buffer_size);

    static VertexWeightStream CreateFromSerializedData (const void* buffer, size_t buffer_size, size_t& read_bytes);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Объект оповещения об удалении
///////////////////////////////////////////////////////////////////////////////////////////////////
    xtl::trackable& Trackable () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (VertexWeightStream&);

  private:
    struct Impl;
    
    VertexWeightStream (Impl*);
    
  private:
    xtl::intrusive_ptr<Impl> impl;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение объекта оповещения об удалении
///////////////////////////////////////////////////////////////////////////////////////////////////
xtl::trackable& get_trackable (const VertexWeightStream&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
void swap (VertexWeightStream&, VertexWeightStream&);

#include <media/geometry/detail/vertex_stream.inl>

}

}

#endif
