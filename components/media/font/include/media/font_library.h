#ifndef MEDIALIB_FONT_LIBRARY_HEADER
#define MEDIALIB_FONT_LIBRARY_HEADER

#include <media/font.h>

#include <xtl/functional_fwd>

namespace media
{

struct FontCreationParams
{
  size_t      font_size;
  size_t      font_size_eps;
  size_t      weight;      //+constants
  int         escapement;
  bool        bold;
  bool        itallic;
  bool        underlined;
  bool        striked;
  float       stroke_size;
  size_t      horizontal_dpi;
  size_t      vertical_dpi;
  const char* charset;
};

class IFontDesc
{
  public:
    virtual size_t FontsCount () = 0;
    virtual const char* FamilyName (size_t index) = 0;
    virtual const char* StyleName (size_t index) = 0;

    virtual Font CreateFont    (size_t index, const FontCreationParams&) = 0;
    virtual bool CanCreateFont (size_t index, const FontCreationParams&) = 0;

    virtual void AddRef () = 0;
    virtual void Release () = 0;

 protected:
    virtual ~IFontDesc () {}
};

class FontDesc
{
  public:
    FontDesc  (const FontDesc&);
    ~FontDesc ();    

    FontDesc& operator = (const FontDesc&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Имя файла
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* Source () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Имя гарнитуры / имя семейства / имя стиля
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* FamilyName () const;
    const char* StyleName  () const;
    
    Font CreateFont     (const FontCreationParams&) const;
    bool CanCreateFont  (const FontCreationParams&) const;

  private:
    FontDesc (const char* source, IFontDesc* desc, size_t index);

  private:
    struct Impl
    Impl* impl;
};

class FontLibrary
{
  public:
    typedef xtl::iterator<FontDesc>       Iterator;
    typedef xtl::iterator<const FontDesc> ConstIterator;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор / присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    FontLibrary  ();
    FontLibrary  (const FontLibrary& source);
    ~FontLibrary ();

    FontLibrary& operator = (const FontLibrary&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Имя библиотеки
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* Name    () const;
    void        SetName (const char* name);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Количество дескрипторов шрифтов в библиотеке / проверка на пустоту
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t Size    () const;
    bool   IsEmpty () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение итератора
///////////////////////////////////////////////////////////////////////////////////////////////////
    Iterator      CreateIterator ();
    ConstIterator CreateIterator () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение идентификатора шрифта
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* ItemId (const ConstIterator&) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Поиск
///////////////////////////////////////////////////////////////////////////////////////////////////
    FontDesc Find (const char* name) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Очистка библиотеки
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Clear ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Загрузка шрифта
///////////////////////////////////////////////////////////////////////////////////////////////////
    void LoadFont    (const char* file_name);
    void LoadFonts   (const char* wildcard);
    void UnloadFont  (const char* file_name);
    void UnloadFonts (const char* wildcard);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание шрифта
///////////////////////////////////////////////////////////////////////////////////////////////////
    Font CreateFont (const char* name, const FontCreationParams& params);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Управление параметрами кэширования
///////////////////////////////////////////////////////////////////////////////////////////////////
    void EnableCache   () { SetCacheState (true); }
    void DisableCache  () { SetCacheState (false); }
    void SetCacheState (bool state);
    bool CacheState    () const;

    void        SetCacheDir (const char* dir_name);
    const char* CacheDir    () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Swap (FontLibrary&);

  private:
    struct Impl;
    Impl* impl;
};

//////////////////////////////////////////////////////////////////////////////////////////////////
///Обмен
//////////////////////////////////////////////////////////////////////////////////////////////////
void swap (FontLibrary&, FontLibrary&);

//////////////////////////////////////////////////////////////////////////////////////////////////
///Менеджер шрифтов
//////////////////////////////////////////////////////////////////////////////////////////////////
typedef common::ResourceSerializerManager<IFontDesc* (const char*), void (const char*, const Font&)> FontManager;

}

#endif
