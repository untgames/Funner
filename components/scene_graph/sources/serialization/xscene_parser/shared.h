#ifndef SCENE_GRAPH_XSCENE_PARSER_SHARED_HEADER
#define SCENE_GRAPH_XSCENE_PARSER_SHARED_HEADER

#include <stl/hash_map>

#include <xtl/bind.h>
#include <xtl/common_exceptions.h>
#include <xtl/function.h>
#include <xtl/intrusive_ptr.h>
#include <xtl/reference_counter.h>
#include <xtl/signal.h>
#include <xtl/shared_ptr.h>
#include <xtl/token_iterator.h>

#include <math/utility.h>

#include <common/component.h>
#include <common/file.h>
#include <common/log.h>
#include <common/parser.h>
#include <common/property_map.h>
#include <common/singleton.h>
#include <common/strlib.h>

#include <media/rms/manager.h>

#include <sg/camera.h>
#include <sg/light.h>
#include <sg/listener.h>
#include <sg/mesh.h>
#include <sg/scene_manager.h>
#include <sg/scene_parser.h>
#include <sg/sound_emitter.h>
#include <sg/sprite.h>
#include <sg/text_line.h>

namespace scene_graph
{

typedef xtl::shared_ptr<ISceneParser> SceneParserPtr;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Фабрика XML сцен
///////////////////////////////////////////////////////////////////////////////////////////////////
class XmlSceneFactory: public ISceneFactory, public xtl::reference_counter, public xtl::noncopyable
{
  public:
    typedef SceneManager::LogHandler LogHandler;
  
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    XmlSceneFactory  (const char* file_name, const LogHandler& log_handler);
    ~XmlSceneFactory ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Перечисление сцен
///////////////////////////////////////////////////////////////////////////////////////////////////
    void EnumScenes (const SceneEnumerator& handler);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение информации о сцене
///////////////////////////////////////////////////////////////////////////////////////////////////
    bool GetSceneInfo (const char* name, ResourceGroup* resources); //if resources != 0 && scene present -> fill resources needed for scene

///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание сцены
///////////////////////////////////////////////////////////////////////////////////////////////////
    void CreateScene (const char* name, Node& parent, SceneContext& scene_context);

  private:
    struct Impl;
    stl::auto_ptr<Impl> impl;
};

typedef xtl::intrusive_ptr<XmlSceneFactory> XmlSceneFactoryPtr;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Реализация менеджера парсинга XML сцен
///////////////////////////////////////////////////////////////////////////////////////////////////
class XmlSceneParserManagerImpl
{
  public:
    typedef XmlSceneParserManager::SceneParserCreator SceneParserCreator;
    typedef SceneManager::LogHandler                  LogHandler;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Регистрация парсеров
///////////////////////////////////////////////////////////////////////////////////////////////////
    void RegisterParser       (const char* version, const SceneParserCreator& parser);
    void UnregisterParser     (const char* version);
    void UnregisterAllParsers ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Версия парсера по умолчанию
///////////////////////////////////////////////////////////////////////////////////////////////////
    void        SetDefaultVersion (const char* version);
    const char* DefaultVersion    () const;
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание парсера
///////////////////////////////////////////////////////////////////////////////////////////////////
    SceneParserPtr CreateParser (const common::ParseNode&);
    
  private:
    typedef stl::hash_map<stl::hash_key<const char*>, SceneParserCreator> CreatorMap;
    
  private:
    CreatorMap  creators;
    stl::string default_version;
};

typedef common::Singleton<XmlSceneParserManagerImpl> XmlSceneParserManagerSingleton;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Имя корневого узла XML сцен
///////////////////////////////////////////////////////////////////////////////////////////////////
extern const char* XSCENE_ROOT;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Разбор атрибута
///////////////////////////////////////////////////////////////////////////////////////////////////
void parse_attribute (const common::ParseNode& decl, const char* name, size_t size, float* value);

}

#endif
