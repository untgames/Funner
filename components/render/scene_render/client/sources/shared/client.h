#ifndef RENDER_SCENE_CLIENT_SHARED_HEADER
#define RENDER_SCENE_CLIENT_SHARED_HEADER

#include <stl/auto_ptr.h>

#include <render/scene/interchange/property_synchronizer.h>

#include <shared/types.h>

namespace render
{

namespace scene
{

namespace client
{

class FontManager;
class MaterialManager;
class SceneManager;

typedef interchange::PropertyMapAutoWriter::Synchronizer PropertyMapSynchronizer;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Тип синхронизируемого объекта
///////////////////////////////////////////////////////////////////////////////////////////////////
enum ObjectType
{
  ObjectType_Viewport,
  ObjectType_RenderTarget,
  ObjectType_Node,  
  ObjectType_Fence,

  ObjectType_Num
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Слушатель событий синхронизации
///////////////////////////////////////////////////////////////////////////////////////////////////
class IFenceListener
{
  public:
    virtual void OnFenceTriggered (object_id_t tag) = 0;

  protected:
    virtual ~IFenceListener () {}
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Реализация рендера сцены
///////////////////////////////////////////////////////////////////////////////////////////////////
class ClientImpl: public xtl::noncopyable
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    ClientImpl  ();
    ~ClientImpl ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Связывание с контекстом
///////////////////////////////////////////////////////////////////////////////////////////////////
    void SetContext (Context*);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Выделение идентификаторов
///////////////////////////////////////////////////////////////////////////////////////////////////
    interchange::object_id_t AllocateId   (ObjectType type);
    void                     DeallocateId (ObjectType type, interchange::object_id_t id);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Синхронизация свойств
///////////////////////////////////////////////////////////////////////////////////////////////////
    PropertyMapSynchronizer CreateSynchronizer  (const common::PropertyMap&);
    common::PropertyMap     GetServerProperties (object_id_t id); 

///////////////////////////////////////////////////////////////////////////////////////////////////
///Выполнение синхронизации с сервером
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Synchronize ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обработчики ответов сервера
///////////////////////////////////////////////////////////////////////////////////////////////////
    void FenceResponse (object_id_t tag);

    void UpdatePropertyMap    (interchange::InputStream&);
    void RemovePropertyMap    (object_id_t id);
    void RemovePropertyLayout (object_id_t id);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Синхронизация
///////////////////////////////////////////////////////////////////////////////////////////////////
    void RegisterFenceListener   (object_id_t tag, IFenceListener* listener);
    void UnregisterFenceListener (object_id_t tag, IFenceListener* listener);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Менеджеры
///////////////////////////////////////////////////////////////////////////////////////////////////
    client::SceneManager&    SceneManager    ();
    client::MaterialManager& MaterialManager ();
    client::FontManager&     FontManager     ();

  private:
    struct Impl;
    stl::auto_ptr<Impl> impl;
};

}

}

}

#endif
