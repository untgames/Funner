///////////////////////////////////////////////////////////////////////////////////////////////////
///Список соединений объекта
///////////////////////////////////////////////////////////////////////////////////////////////////
class EntityJointList: public Object
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    EntityJointList ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Количество соединений
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t Size   () { return transformations.size (); }
    void   Resize (size_t joints_count);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Трансформации
///////////////////////////////////////////////////////////////////////////////////////////////////
    const math::mat4f* Transformations   ();
    void               SetTransformation (size_t joint_index, const math::mat4f& tm);
    const math::mat4f& Transformation    (size_t joint_index);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Ревизия обновления
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t UpdateRevisionId () { return update_revision_id; }

  private:
    typedef stl::vector<math::mat4f> MatrixArray;

  private:
    MatrixArray transformations;
    size_t      update_revision_id;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Вершинный буфер скин-меша
///////////////////////////////////////////////////////////////////////////////////////////////////
class SkinVertexBuffer: public Object
{
  public: 
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    SkinVertexBuffer (const DeviceManagerPtr&, const VertexBufferPtr&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение вершинного потока
///////////////////////////////////////////////////////////////////////////////////////////////////
    const LowLevelBufferPtr& VertexStream () { return vertex_stream; }
    int                      VertexStreamIndex () { return vertex_stream_index; }

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обновление буфера
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Update (EntityJointList& joints);

  private:
    VertexBufferPtr     vertex_buffer;
    LowLevelBufferPtr   vertex_stream;
    size_t              vertices_count;
    SkinVertex*         vertex_cache;
    const VertexWeight* vertex_weights;
    int                 vertex_stream_index;
    size_t              cached_update_revision_id;
};

typedef xtl::intrusive_ptr<SkinVertexBuffer> SkinVertexBufferPtr;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Динамический примитив для скин-меша
///////////////////////////////////////////////////////////////////////////////////////////////////
class SkinDynamicPrimitive: public DynamicPrimitive, public DebugIdHolder, private RendererPrimitiveGroup
{
  public:
    typedef xtl::function<void (RendererPrimitive&)> FillRendererPrimitiveHandler;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    SkinDynamicPrimitive (const SkinVertexBufferPtr&          skin_vertex_buffer,
                          EntityImpl&                         entity, //без захвата владения entity
                          const FillRendererPrimitiveHandler& fill_renderer_primitive_fn);
    ~SkinDynamicPrimitive ();

  private:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Обновление
///////////////////////////////////////////////////////////////////////////////////////////////////
    void UpdateOnPrerenderCore (EntityImpl& in_entity);
    void UpdateOnRenderCore    (FrameImpl& frame, EntityImpl& entity, RenderingContext& context, const math::mat4f& mvp_matrix) {}

///////////////////////////////////////////////////////////////////////////////////////////////////
///Кэшируемый источник требует обновления кэша
///////////////////////////////////////////////////////////////////////////////////////////////////  
    void UpdateCacheCore ();
    void ResetCacheCore  ();

  private:
    typedef xtl::intrusive_ptr<SkinVertexBuffer> SkinVertexBufferPtr;

  private:
    EntityImpl&                  entity; //should not be retained
    Log                          log;
    SkinVertexBufferPtr          skin_vertex_buffer;
    FillRendererPrimitiveHandler fill_renderer_primitive_handler;
    LowLevelStateBlockPtr        cached_state_block;
    size_t                       cached_state_block_mask_hash;
    RendererPrimitive            cached_primitive;
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Прототип примитива skin меша
///////////////////////////////////////////////////////////////////////////////////////////////////
class SkinDynamicPrimitivePrototype: public DynamicPrimitivePrototype
{
  public:
    typedef SkinDynamicPrimitive::FillRendererPrimitiveHandler FillRendererPrimitiveHandler;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    SkinDynamicPrimitivePrototype (VertexBuffer& vertex_buffer, const FillRendererPrimitiveHandler& fill_renderer_primitive_fn);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Вершинный буфер
///////////////////////////////////////////////////////////////////////////////////////////////////
    manager::VertexBuffer& VertexBuffer() { return vertex_buffer; }

///////////////////////////////////////////////////////////////////////////////////////////////////
///Создание экземпляра
///////////////////////////////////////////////////////////////////////////////////////////////////
    DynamicPrimitive* CreateDynamicPrimitiveInstance (EntityImpl& entity, DynamicPrimitiveEntityStorage& dynamic_storage);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обновление кэш значений
///////////////////////////////////////////////////////////////////////////////////////////////////
    void TouchCacheValues (DynamicPrimitiveEntityStorage& storage);

  private:
    manager::VertexBuffer&       vertex_buffer;                    //ссылка на вершинный буфер (without ownership)
    FillRendererPrimitiveHandler fill_renderer_primitive_handler;  //функтор заполнения параметров примитива рендеринга
};

typedef xtl::intrusive_ptr<SkinDynamicPrimitivePrototype> SkinDynamicPrimitivePrototypePtr;
