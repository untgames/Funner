///////////////////////////////////////////////////////////////////////////////////////////////////
///Материал
///////////////////////////////////////////////////////////////////////////////////////////////////
class MaterialImpl: public Object, public CacheSource
{
  public:
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструктор / деструктор
///////////////////////////////////////////////////////////////////////////////////////////////////
    MaterialImpl  (const DeviceManagerPtr&, const TextureManagerPtr&, const ProgramManagerPtr&, const char* name = ""); //TODO: const EffectManagerPtr&
    MaterialImpl  (const MaterialImpl&);
    ~MaterialImpl ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Имя материала
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* Name    ();
    void        SetName (const char* id);

//TODO: blend mode hash (0 if no custom blend mode)
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Блок состояний материала
///////////////////////////////////////////////////////////////////////////////////////////////////
    LowLevelStateBlockPtr StateBlock ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение объекта расположения параметров программы шейдинга
///////////////////////////////////////////////////////////////////////////////////////////////////
    ProgramParametersLayoutPtr ParametersLayout ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Программа шейдинга
///////////////////////////////////////////////////////////////////////////////////////////////////
    ProgramPtr Program ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение текстуры
///////////////////////////////////////////////////////////////////////////////////////////////////
    unsigned int             TexturesCount ();
    TexturePtr               Texture       (unsigned int index); //может вернуть 0 в случае динамической текстуры
    LowLevelTexturePtr       DeviceTexture (unsigned int index); //может вернуть 0 в случае динамической текстуры
    const char*              TextureName   (unsigned int index);
    LowLevelSamplerStatePtr  Sampler       (unsigned int index);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обновление отдельных текстур
///////////////////////////////////////////////////////////////////////////////////////////////////
    void        SetTexmap     (const char* semantic, const char* name, const char* sampler); //name == null && sampler == null -> remove
    const char* TexmapImage   (const char* semantic); //null if not exist
    const char* TexmapSampler (const char* semantic); //null if not exist
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Тэги
///////////////////////////////////////////////////////////////////////////////////////////////////
    size_t        TagsCount ();
    const size_t* Tags      ();
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Есть ли в материале динамические текстуры
///////////////////////////////////////////////////////////////////////////////////////////////////
    bool HasDynamicTextures ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Обновление материала
///////////////////////////////////////////////////////////////////////////////////////////////////
    void Update (const media::rfx::Material&);
    
///////////////////////////////////////////////////////////////////////////////////////////////////
///Управление кэшированием
///////////////////////////////////////////////////////////////////////////////////////////////////
    using CacheSource::UpdateCache;
    using CacheSource::ResetCache;
    
  private:
    void UpdateCacheCore ();
    void ResetCacheCore ();    

  private:
    struct Impl;
    stl::auto_ptr<Impl> impl;
};
