#ifndef RENDER_GL_DRIVER_CONTEXT_MANAGER_HEADER
#define RENDER_GL_DRIVER_CONTEXT_MANAGER_HEADER

#include <render/low_level/driver.h>
#include <gl/glew.h>

namespace render
{

namespace low_level
{

namespace opengl
{

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение контекста GLEW (имя функции выбрано исходя из требований GLEW)
///////////////////////////////////////////////////////////////////////////////////////////////////
const GLEWContext* glewGetContext ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Идентификатор таблицы локальных данных контекста
///////////////////////////////////////////////////////////////////////////////////////////////////
enum ContextDataTable
{
  ContextDataTable_InputStage,
  ContextDataTable_ShaderStage,
  ContextDataTable_RasterizerStage,
  ContextDataTable_OutputStage,
  
  ContextDataTable_Num
};

///////////////////////////////////////////////////////////////////////////////////////////////////
///Количество элементов в каждой из таблиц локальных данных контекста
///////////////////////////////////////////////////////////////////////////////////////////////////
const size_t CONTEXT_DATA_TABLE_SIZE = 64;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Менеджер контекстов OpenGL (политика копирования - подсчёт ссылок)
///////////////////////////////////////////////////////////////////////////////////////////////////
class ContextManager
{
  public:
    typedef xtl::function<void (const char*)> LogHandler;
  
///////////////////////////////////////////////////////////////////////////////////////////////////
///Конструкторы / деструктор / присваивание
///////////////////////////////////////////////////////////////////////////////////////////////////
    ContextManager  (const LogHandler& log_handler);
    ContextManager  (const ContextManager&);
    ~ContextManager ();

    ContextManager& operator = (const ContextManager&);

///////////////////////////////////////////////////////////////////////////////////////////////////
///Выбор активных цепочек обмена
///////////////////////////////////////////////////////////////////////////////////////////////////
    void        SetSwapChains    (ISwapChain* draw_swap_chain, ISwapChain* read_swap_chain);
    ISwapChain* GetDrawSwapChain () const;
    ISwapChain* GetReadSwapChain () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Активация текущего контекста
///////////////////////////////////////////////////////////////////////////////////////////////////
    void MakeContextCurrent () const;
    bool IsContextCurrent   () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Работа с таблицей локальных данных контекста
///////////////////////////////////////////////////////////////////////////////////////////////////
    void   SetContextData   (ContextDataTable table_id, size_t element_id, size_t value);
    size_t GetContextData   (ContextDataTable table_id, size_t element_id) const;
    void   ClearContextData (ContextDataTable table_id);
    void   ClearContextData ();

///////////////////////////////////////////////////////////////////////////////////////////////////
///Получение строки со списком расширений, зависящих от активной цепочки обмена
///////////////////////////////////////////////////////////////////////////////////////////////////
    const char* GetSwapChainsExtensionString () const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Проверка совместимости менеджеров контекстов
///////////////////////////////////////////////////////////////////////////////////////////////////
    bool IsCompatible (const ContextManager&) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Протоколирование
///////////////////////////////////////////////////////////////////////////////////////////////////
    void LogPrintf  (const char* format, ...) const;
    void LogVPrintf (const char* format, va_list args) const;

///////////////////////////////////////////////////////////////////////////////////////////////////
///Проверка ошибок OpenGL
///////////////////////////////////////////////////////////////////////////////////////////////////    
    void CheckErrors (const char* source) const;

  private:
    struct Impl;
    Impl* impl;
};

}

}

}

#endif
